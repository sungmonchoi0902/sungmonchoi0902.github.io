<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Meet Myself Through Shout</title>

<!-- ì•ˆì •ì ìœ¼ë¡œ ë§ˆì´í¬ê°€ ë™ì‘í•˜ëŠ” p5.js + p5.sound ë²„ì „ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>

<style>
  body {
    margin: 0;
    padding: 0;
    background: black;
    color: white;
    font-family: "Helvetica", sans-serif;
    text-align: center;
  }
  .title { margin-top: 40px; font-size: 32px; font-weight: 600; }
  .desc { margin-top: 10px; font-size: 14px; opacity: 0.7; line-height: 1.5; }
  .line { width: 60%; margin: 25px auto; border-bottom: 1px solid #444; }
  #sketch { margin-top: 25px; }
</style>
</head>

<body>

<div class="title">Meet my self through shout</div>
<div class="desc">
  The emotions youâ€™ve hidden, the voice youâ€™ve been suppressing.<br>
  The moment the volume rises, your true self, once concealed, awakens.
</div>
<div class="line"></div>
<div id="sketch"></div>

<script>
let cam;
let mic;
let smoothVol = 0;

let bgOsc1, bgOsc2, bgOsc3;
let beepOsc;

let bgOn = true;
let beepOn = false;

let cleanMode = false; 
let cleanUntil = 0;

// ğŸ”¥ ë°ìŠ¤í¬íƒ‘ ì…ë ¥ ê¸°ì¤€ threshold ë‚®ì¶¤
const THRESHOLD = 0.01;

function setup() {
  let c = createCanvas(640, 480);
  c.parent("sketch");

  pixelDensity(1);

  cam = createCapture(VIDEO);
  cam.size(320, 240);
  cam.hide();

  mic = new p5.AudioIn();

  // ğŸ”¥ í´ë¦­ ì „ê¹Œì§€ ì˜¤ë””ì˜¤ ì‹œì‘ë˜ì§€ ì•Šë„ë¡ ì¼ë‹¨ start() ë¯¸ë£¨ê¸°
  // mic.start();

  noStroke();
  rectMode(CORNER);
  frameRate(30);

  // Background oscillators
  bgOsc1 = new p5.Oscillator('sine');
  bgOsc2 = new p5.Oscillator('sine');
  bgOsc3 = new p5.Oscillator('sine');

  bgOsc1.freq(130.81);
  bgOsc2.freq(293.66);
  bgOsc3.freq(493.88);

  bgOsc1.amp(0.03);
  bgOsc2.amp(0.025);
  bgOsc3.amp(0.02);

  bgOsc1.start();
  bgOsc2.start();
  bgOsc3.start();

  beepOsc = new p5.Oscillator('sine');
  beepOsc.freq(880);
  beepOsc.amp(0);
  beepOsc.start();
}

function draw() {
  background(0);

  if (!mic.enabled) return; // ğŸ”¥ ì˜¤ë””ì˜¤ ì‹œì‘ ì „ draw ì•ˆì „ ì²˜ë¦¬

  let vol = mic.getLevel();
  smoothVol = lerp(smoothVol, vol, 0.1);

  console.log("volume:", vol); // ğŸ”¥ ì‹¤ì œ ì…ë ¥ í™•ì¸ìš© (ì§€ìš°ì§€ ë§ˆ!)

  let mosaicSize = int(map(smoothVol, 0, THRESHOLD, 60, 1, true));

  cam.loadPixels();
  if (cam.pixels.length === 0) return;

  // Clean mode íŒë‹¨
  if (millis() < cleanUntil) {
    cleanMode = true;
  } else {
    cleanMode = (mosaicSize <= 2);
  }

  if (cleanMode && millis() >= cleanUntil) {
    cleanUntil = millis() + 3000; 
  }

  push();
  translate(width, 0);
  scale(-1, 1);

  if (!cleanMode) {
    // mosaic mode
    for (let y = 0; y < cam.height; y += mosaicSize) {
      for (let x = 0; x < cam.width; x += mosaicSize) {
        let i = (y * cam.width + x) * 4;
        fill(cam.pixels[i], cam.pixels[i+1], cam.pixels[i+2]);
        rect(x * 2, y * 2, mosaicSize * 2, mosaicSize * 2);
      }
    }

    // turn off beep
    if (beepOn) {
      beepOsc.amp(0, 0.3);
      beepOn = false;
    }

    // turn on bg
    if (!bgOn) {
      bgOsc1.amp(0.03, 0.5);
      bgOsc2.amp(0.025, 0.5);
      bgOsc3.amp(0.02, 0.5);
      bgOn = true;
    }

  } else {
    // clean mode
    image(cam, 0, 0, width, height);

    if (!beepOn) {
      beepOsc.amp(0.2, 0.2);
      beepOn = true;
    }
    if (bgOn) {
      bgOsc1.amp(0, 0.5);
      bgOsc2.amp(0, 0.5);
      bgOsc3.amp(0, 0.5);
      bgOn = false;
    }
  }

  pop();
}

// ğŸ”¥ ë¸Œë¼ìš°ì €ê°€ ìš”êµ¬í•˜ëŠ” "ì‚¬ìš©ì ì¸í„°ë™ì…˜ í›„ ì˜¤ë””ì˜¤ ì‹œì‘"
function mousePressed() {
  userStartAudio();
  mic.start(() => {
    console.log("Microphone started!");
  });
}
</script>

</body>
</html>