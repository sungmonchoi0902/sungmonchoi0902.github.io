<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Meet Myself Through Shout</title>

<!-- p5.js + 사운드 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>

<!-- 디자인 -->
<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
  }
  .title { margin-top: 40px; font-size: 32px; }
  .desc { opacity: 0.7; margin-top: 10px; font-size: 14px; }
  .line { width: 60%; margin: 25px auto; border-bottom: 1px solid #444; }
  #startBtn {
    padding: 10px 20px;
    margin-bottom: 20px;
    font-size: 14px;
    border: none;
    background: white;
    color: black;
    cursor: pointer;
  }
</style>
</head>

<body>

<div class="title">Meet my self through shout</div>
<div class="desc">
  The emotions you’ve hidden, the voice you’ve been suppressing.<br>
  The moment the volume rises, your true self, once concealed, awakens.
</div>
<div class="line"></div>

<!-- 마이크 켜기 버튼 -->
<button id="startBtn">Activate Microphone</button>

<!-- p5.js 스케치 -->
<div id="sketch"></div>

<script>
// 카메라/마이크 변수
let cam, mic;
let smoothVol = 0;

// 짧은 사운드(삐 소리)
let beep;

// 배경 사운드(살짝 웅~)
let bg;

// 화면 깨끗 모드인지
let clean = false;

function setup() {
  // 캔버스 만들기
  let c = createCanvas(640, 480);
  c.parent("sketch");

  // 카메라 설정
  cam = createCapture(VIDEO);
  cam.size(320, 240);
  cam.hide();

  // 마이크 준비 (아직 시작 안 함)
  mic = new p5.AudioIn();

  // 버튼 누르면 마이크 활성화
  document.getElementById("startBtn").onclick = () => {
    userStartAudio(); // 마이크 켜기 위한 필수 코드
    mic.start();
    document.getElementById("startBtn").style.display = "none";
  };

  // 배경 사운드(살짝)
  bg = new p5.Oscillator('sine');
  bg.freq(200);
  bg.amp(0.03);
  bg.start();

  // 삐 소리
  beep = new p5.Oscillator('sine');
  beep.freq(880);
  beep.amp(0);
  beep.start();
}

function draw() {
  background(0);

  // 마이크 볼륨 받아오기
  let vol = mic.getLevel();
  smoothVol = lerp(smoothVol, vol, 0.1);

  // 볼륨 커지면 깨끗 모드로 진입
  clean = (smoothVol > 0.03);

  push();
  translate(width, 0);
  scale(-1, 1); // 좌우 반전

  // 깨끗 모드 → 그냥 카메라 보여줌
  if (clean) {
    image(cam, 0, 0, width, height);

    // 삐 소리 켜기
    beep.amp(0.2, 0.2);
    // 배경음 줄이기
    bg.amp(0, 0.3);

  } else {
    // 모자이크 크기 계산 (목소리 작으면 큼 / 크면 작아짐)
    let size = int(map(smoothVol, 0, 0.05, 60, 3, true));

    cam.loadPixels();

    // 바둑판으로 나눠서 색 채우기 = 모자이크
    for (let y = 0; y < cam.height; y += size) {
      for (let x = 0; x < cam.width; x += size) {
        let i = (y * cam.width + x) * 4;
        fill(cam.pixels[i], cam.pixels[i+1], cam.pixels[i+2]);
        rect(x * 2, y * 2, size * 2, size * 2);
      }
    }

    // 삐 소리 꺼짐
    beep.amp(0, 0.3);
    // 배경음 다시 켜기
    bg.amp(0.03, 0.3);
  }

  pop();
}
</script>

</body>
</html>