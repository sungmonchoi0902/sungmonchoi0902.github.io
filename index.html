<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Meet Myself Through Shout</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>
<style>
  body {
    margin: 0;
    padding: 0;
    background: black;
    color: white;
    font-family: "Helvetica", sans-serif;
    text-align: center;
  }

  .title {
    margin-top: 40px;
    font-size: 32px;
    font-weight: 600;
    letter-spacing: 1px;
  }

  .desc {
    margin-top: 10px;
    font-size: 14px;
    line-height: 1.5;
    opacity: 0.7;
  }

  .line {
    width: 60%;
    margin: 25px auto;
    border-bottom: 1px solid #444;
  }

  #sketch {
    margin-top: 25px;
  }

  /* small overlay for instructions */
  #hint {
    position: fixed;
    left: 12px;
    bottom: 12px;
    padding: 8px 10px;
    background: rgba(255,255,255,0.06);
    color: #fff;
    font-size: 13px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.05);
  }
</style>
</head>

<body>

<div class="title">Meet myself through shout</div>

<div class="desc">
  The emotions you’ve hidden, the voice you’ve been suppressing.<br>
  The moment the volume rises, your true self, once concealed, awakens.
</div>

<div class="line"></div>

<div id="sketch"></div>

<div id="hint">Click / tap the canvas to enable audio. Open Console to see <code>vol</code>.</div>

<script>
let cam;
let mic;
let smoothVol = 0;
let bgOsc1, bgOsc2, bgOsc3;
let beepOsc;
let bgOn = true;
let beepOn = false;

let cleanMode = false;
let cleanUntil = 0;

let audioStarted = false; // track whether we called userStartAudio + mic.start

function setup() {
  let c = createCanvas(640, 480);
  c.parent("sketch");

  pixelDensity(1);

  cam = createCapture(VIDEO);
  cam.size(320, 240);
  cam.hide();

  // create mic but DO NOT start until user interaction
  mic = new p5.AudioIn();

  noStroke();
  rectMode(CORNER);
  frameRate(30);

  bgOsc1 = new p5.Oscillator('sine');
  bgOsc2 = new p5.Oscillator('sine');
  bgOsc3 = new p5.Oscillator('sine');

  bgOsc1.freq(130.81);
  bgOsc2.freq(293.66);
  bgOsc3.freq(493.88);

  // start bg oscillators with zero amp initially for safety (fade in later)
  bgOsc1.amp(0);
  bgOsc2.amp(0);
  bgOsc3.amp(0);

  bgOsc1.start();
  bgOsc2.start();
  bgOsc3.start();

  beepOsc = new p5.Oscillator('sine');
  beepOsc.freq(880);
  beepOsc.amp(0);
  beepOsc.start();
}

function draw() {
  background(0);

  // if audio hasn't been started yet, vol remains 0
  let vol = 0;
  if (audioStarted) {
    vol = mic.getLevel();
    // debug: print a sampled value occasionally (throttle to avoid console spam)
    if (frameCount % 15 === 0) {
      console.log("vol:", nf(vol, 1, 4));
    }
  }

  smoothVol = lerp(smoothVol, vol, 0.1);

  // show the current volume on-screen for quick feedback
  push();
  fill(255);
  textSize(14);
  textAlign(LEFT, TOP);
  text("Volume: " + nf(smoothVol, 1, 3), 8, 8);
  text("Click/tap canvas to enable audio", 8, 26);
  pop();

  let mosaicSize = int(map(smoothVol, 0, 0.3, 60, 1, true));

  cam.loadPixels();
  if (cam.pixels.length === 0) return;

  if (millis() < cleanUntil) {
    cleanMode = true;
  } else {
    cleanMode = (mosaicSize <= 2);
  }

  if (cleanMode && millis() >= cleanUntil) {
    cleanUntil = millis() + 3000;
  }

  push();
  translate(width, 0);
  scale(-1, 1);

  if (!cleanMode) {
    for (let y = 0; y < cam.height; y += mosaicSize) {
      for (let x = 0; x < cam.width; x += mosaicSize) {
        let i = (y * cam.width + x) * 4;
        fill(cam.pixels[i], cam.pixels[i+1], cam.pixels[i+2]);
        rect(x * 2, y * 2, mosaicSize * 2, mosaicSize * 2);
      }
    }

    // beep off, bg on
    if (beepOn) {
      beepOsc.amp(0, 0.3);
      beepOn = false;
    }
    if (!bgOn) {
      bgOsc1.amp(0.03, 0.5);
      bgOsc2.amp(0.025, 0.5);
      bgOsc3.amp(0.02, 0.5);
      bgOn = true;
    }

  } else {
    image(cam, 0, 0, width, height);

    if (!beepOn) {
      beepOsc.amp(0.2, 0.2);
      beepOn = true;
    }
    if (bgOn) {
      bgOsc1.amp(0, 0.5);
      bgOsc2.amp(0, 0.5);
      bgOsc3.amp(0, 0.5);
      bgOn = false;
    }
  }

  pop();
}

// click handler to enable audio in browsers that block autoplay
function mousePressed() {
  startAudioIfNeeded();
}

// also allow touch (mobile)
function touchStarted() {
  startAudioIfNeeded();
  // prevent default to avoid double events sometimes on mobile
  return false;
}

function startAudioIfNeeded() {
  if (!audioStarted) {
    // resume audio context and start microphone
    userStartAudio();         // p5 helper to unlock audio
    getAudioContext().resume();
    mic.start();
    audioStarted = true;
    console.log("Audio started: mic listening");
    // optionally fade in background sound a little to make it audible as feedback
    bgOsc1.amp(0.03, 0.5);
    bgOsc2.amp(0.025, 0.5);
    bgOsc3.amp(0.02, 0.5);
  }
}
</script>

</body>
</html>